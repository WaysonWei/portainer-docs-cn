# MicroK8s

## 介绍

Portainer由两个组件组成：_Portainer Server_和_Portainer Agent_。这两个组件都作为轻量级容器运行在Kubernetes上。本文档将介绍如何将Portainer连接到您现有的基础设施以部署MicroK8s并安装Portainer Agent。如果您还没有可用的Portainer Server实例，请先参考[Portainer Server安装指南](../../../../../start/install/server/kubernetes/baremetal.md)。

## 前提条件

为了连接并在您现有的基础设施上部署MicroK8s和Portainer Agent，您需要：

* 一台或多台基于Linux的机器用于部署MicroK8s。我们主要在Ubuntu 20.04 LTS上进行了测试，但大多数类似的Linux发行版应该都可以工作。这些机器可以是裸金属服务器或虚拟机。
* 对上述机器具有root或无密码sudo SSH访问权限，端口为`22`。这是安装MicroK8s所必需的。Portainer支持基于密码和基于密钥的认证。
* 在上述机器上安装`snap`工具。您可以在[Snapcraft网站](https://snapcraft.io/docs/installing-snapd)找到大多数Linux发行版的安装说明。`snap`工具用于安装MicroK8s和任何选定的插件。
* Portainer Server与上述机器之间以及集群中各机器之间的通信。这是为了确保Portainer Server既可以在初始安装时访问这些机器，也可以在集群启动运行后与Portainer Agent通信，并且集群节点之间可以相互通信。
* 对于标准安装，需要从部署MicroK8s的机器访问互联网（特别是Docker Hub和registry.k8s.io）。如果没有互联网访问权限，您可以执行离线安装，但需要完成一些[先决步骤](offline.md)。此外，离线操作可能会影响某些插件的启用。

## 预期结果

出于必要，我们的MicroK8s部署会为您做出一些配置决策。

* Portainer Agent使用NodePort部署，端口为`30778`。&#x20;
* 不同版本的MicroK8s部署之间可能存在一些配置差异。一个显著的差异是从1.25版本开始，如果安装了`ingress`插件，会配置一个名为`nginx`的额外ingress。这在1.24版本中不会发生。我们建议参考[MicroK8s发布说明](https://microk8s.io/docs/release-notes)获取更多细节。
* 部署不会在您的集群上配置任何存储类（除非安装了`hostpath-storage`插件，但不建议用于多节点集群）。由于存储类配置的可能性非常多，这不是我们目前自动提供的功能。我们建议在配置完成后配置一个存储类。

## 部署

要创建并将MicroK8s和Portainer Agent部署到您的机器上，从菜单展开**环境相关**，点击**环境**，然后点击**添加环境**。

<figure><img src="../../../..//assets/2.22-environments-add.gif" alt=""><figcaption></figcaption></figure>

选择**创建Kubernetes集群**并点击**开始向导**，然后选择**MicroK8s**。

如果您尚未[配置一组SSH凭据](../../../../settings/credentials/ssh.md)，系统将要求您现在提供它们。如果您已经配置了凭据集，可以跳转到[集群配置](./#configure-your-cluster)。

### 添加SSH凭据

根据下表填写字段：

| 字段/选项               | 概述                                                                                                             |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 凭据名称           | 输入此凭据集的名称。这将决定它在Portainer中的显示方式。                                    |
| SSH用户名               | 输入您的SSH账户的用户名。                                                                             |
| SSH密码               | 输入您的SSH账户的密码。如果您打算使用SSH密钥认证，可以留空此字段。 |
| 使用SSH密钥认证 | 启用此切换以使用SSH密钥认证而不是密码认证。                                 |
| SSH私钥密码短语 | 如果您的SSH私钥已加密，请在此处提供密码短语。                                                   |
| SSH私钥            | 在此字段中粘贴您的SSH私钥。                                                                            |


您还可以点击**生成新的RSA SSH密钥对**按钮生成新的SSH密钥对，或点击**上传SSH私钥**按钮上传现有的私钥。您可以在我们的[SSH凭据文档](../../../../settings/credentials/ssh.md#generate-a-new-key-pair)中找到生成新SSH密钥的更详细说明。


<figure><img src="../../../..//assets/2.26-environments-add-kube-create-microk8s-creds.png" alt=""><figcaption></figcaption></figure>

输入凭据后，点击**添加凭据**。凭据集将以您输入的名称保存，您将被带到[集群配置](./#configure-your-cluster)。

### 配置您的集群

配置好凭据集后，您可以继续配置集群。根据下表填写字段：

| 字段/选项        | 概述                                                                                                                                                                                                   |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 名称                | 为您的环境输入一个名称。这将决定环境在Portainer中的显示方式。                                                                                                                   |
| 凭据         | 从下拉列表中选择要使用的SSH凭据集。                                                                                                                                                |
| 控制平面节点 | 输入将作为集群**控制平面节点**的机器的IP地址列表，用逗号或换行分隔。您也可以使用连字符指定IP地址范围。 |
| 工作节点        | 输入将作为集群**工作节点**的机器的IP地址列表，用逗号或换行分隔。您也可以使用连字符指定IP地址范围。        |

<figure><img src="../../../..//assets/2.19-environments-create-microk8s-nodes.png" alt=""><figcaption></figcaption></figure>

选择凭据集并输入节点IP后，您可以点击**测试连接**以确保凭据对所有IP地址有效并且可以从Portainer Server实例访问。如果连接节点时出现任何问题，将会显示。

<figure><img src="../../../..//assets/2.19-environments-create-microk8s-test.png" alt=""><figcaption></figcaption></figure>

您现在可以继续配置MicroK8s本身。根据下表填写字段：

| 字段/选项       | 概述                                                                                                                                                                                                                            |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Kubernetes版本 | 选择要在集群上部署的MicroK8s版本。如果启用了**离线安装**，此字段将被禁用。                                                                                                                 |
| 离线安装    | 如果要在没有互联网访问权限的环境上执行安装，请启用此切换。您必须完成[节点的预配置](offline.md)才能进行离线安装。                                   |
| 插件             | 可选点击**添加插件**按钮选择一个或多个插件与MicroK8s安装一起部署。您还可以为每个插件指定所需的任何参数。如果启用了**离线安装**，此选项将被禁用。 |

<figure><img src="../../../..//assets/2.20.3-environments-add-k8s-create-version.png" alt=""><figcaption></figcaption></figure>

作为可选步骤，您可以展开**更多设置**部分以进一步自定义部署。

| 字段/选项    | 概述                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 自定义模板 | 选择在MicroK8s和Portainer Agent安装完成后要在集群上部署的自定义模板。这对于预加载新环境与您的应用程序非常方便。除非模板指定了要使用的命名空间，否则模板将部署在默认命名空间中。您还可以设置模板所需的任何变量。 |
| 组           | 选择在配置完成后将新环境添加到的[组](../../../groups.md)。                                                                                                                                                                                                                                                             |
| 标签            | 选择要添加到环境的任何[标签](../../../tags.md)。                                                                                                                                                                                                                                                                                              |

<figure><img src="../../../..//assets/2.19-environments-create-microk8s-moresettings.png" alt=""><figcaption></figcaption></figure>

输入集群配置详细信息后，点击**配置环境**开始配置。Portainer将开始使用您选择的选项配置您的集群。如果您还有其他环境需要配置，点击**下一步**继续，否则点击**关闭**返回环境列表。

### 配置进度

在环境页面上，您将能够看到任何正在运行的Kubernetes环境配置的进度。状态将随着配置完成而更新，如果配置遇到问题，将在此处显示错误。您可以悬停在状态或错误上以获取更多详细信息。

<figure><img src="../../../..//assets/2.18-environments-add-k8sinstall-creating.png" alt=""><figcaption></figcaption></figure>

配置完成后，您将能够像访问任何其他Portainer配置的环境一样访问该环境。
